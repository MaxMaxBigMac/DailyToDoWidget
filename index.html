<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Machine — 3‑Day Cycle</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111827">
  <style>
    :root {
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827;     /* gray-900 */
      --accent:#22c55e;    /* green-500 */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --chip:#1f2937;      /* gray-800 */
    }
    * { box-sizing:border-box; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width:760px; margin:0 auto; padding:16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    h1 { font-size:20px; margin:0; font-weight:700; letter-spacing:.2px; }
    .sub { font-size:12px; color:var(--muted); }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip { background:var(--chip); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); }
    .chip strong { color:var(--text); }
    .panel { background:var(--panel); border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.25); margin-bottom:12px; }
    .controls, .footer { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button, select, input { background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:10px; padding:8px 10px; font-weight:600; }
    button:hover { border-color:#334155; }
    .list { margin-top:10px; display:grid; gap:8px; }
    .item { display:flex; align-items:flex-start; gap:10px; padding:10px; border:1px solid #1f2937; border-radius:12px; background:#0b1220; }
    .item input[type=checkbox] { width:22px; height:22px; accent-color:var(--accent); margin-top:2px; }
    .item label { flex:1; line-height:1.3; }
    .muted { color:var(--muted); }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .editor h3 { margin:8px 0 6px; }
    textarea { width:100%; min-height:120px; background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:12px; padding:10px; }
    .small { font-size:12px; color:var(--muted); }
    .hint { color:var(--muted); font-size:12px; margin-top:6px; }
    .savebadge { font-size:12px; color:var(--muted); }
    .spacer { flex:1; }
    .warn { border-color:#854d0e; color:#fed7aa; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>The Machine — 3‑Day Cycle</h1>
        <div class="sub">Auto‑rotates at your chosen time (default <strong>3:00 PM</strong>). Checks reset on rollover.</div>
      </div>
      <div class="row">
        <div class="chip">Today: <strong><span id="dayLabel">–</span></strong></div>
        <div class="chip">Next: <span id="nextLabel">–</span></div>
      </div>
    </header>

    <section class="panel">
      <div class="controls">
        <select id="manualDay">
          <option value="auto">Auto (based on time)</option>
          <option value="A">Force Day A</option>
          <option value="B">Force Day B</option>
          <option value="C">Force Day C</option>
        </select>
        <button id="forceNext" class="warn" title="Advance to the next day immediately">Force next day</button>
        <span class="spacer"></span>
        <label>Rollover time: <input id="rolloverHour" type="time" value="15:00"></label>
        <button id="saveRollover">Save</button>
      </div>

      <div class="list" id="list"></div>

      <div class="footer" style="margin-top:10px;">
        <div class="row">
          <div class="chip">Rollover: <strong><span id="rolloverLabel">3:00 PM</span></strong></div>
          <div class="chip">Time to rollover: <strong id="since">–</strong></div>
        </div>
        <div class="savebadge" id="saveState">All changes saved ✔</div>
      </div>
    </section>

    <section class="panel editor" id="editor">
      <div class="grid-2">
        <div>
          <h3>Day A Tasks</h3>
          <textarea id="taA"></textarea>
        </div>
        <div>
          <h3>Day B Tasks</h3>
          <textarea id="taB"></textarea>
        </div>
      </div>
      <div style="margin-top:8px;">
        <h3>Day C Tasks</h3>
        <textarea id="taC"></textarea>
      </div>
      <div class="hint">One task per line. Changes save automatically and persist locally.</div>
      <div class="controls" style="margin-top:8px;">
        <label>Start date: <input id="startDate" type="date"></label>
        <button id="resetChecks" class="warn">Reset checks</button>
        <button id="installBtn" style="display:none;">Install to Home Screen</button>
      </div>
    </section>

    <p class="small">Tip: Add this to your home screen for instant access (Chrome → ⋮ → “Install app” or “Add to Home screen”).</p>
  </div>

<script>
const KEY_CFG = "machine_cfg_v3";
const KEY_STATE = "machine_state_v3";
const KEY_PREF = "machine_pref_v3";

const defaultCfg = {
  startDateISO: new Date().toISOString().slice(0,10), // today
  rolloverHour: 15, // 3 PM by default
  
  tasks: {
    A: [
      "Hygiene — morning",
      "Exercise — 45–60 min",
      "Passive income check — 15 min",
      "Coding / bot dev — Block 1 (90 min)",
      "Coding / bot dev — Block 2 (90 min)",
      "Skill learning / tutorials — 60 min",
      "System testing & automation — 60 min",
      "Art practice — 60 min",
      "Media / News intake — 120 min",
      "Hygiene — night"
    ],
    B: [
      "Hygiene — morning",
      "Exercise — 45–60 min",
      "Passive income check — 15 min",
      "Fundamentals (anatomy/perspective) — 120 min",
      "Project work (Sona refs/scenes) — 120 min",
      "Portfolio / scan / organize — 60 min",
      "Coding maintenance — 60 min",
      "Media study — 120 min",
      "Hygiene — night"
    ],
    C: [
      "Hygiene — morning",
      "Exercise — 45–60 min",
      "Passive income check — 15 min",
      "Research new income streams — 120 min",
      "Optimize existing apps — 60 min",
      "Test new hustles / markets — 60 min",
      "Financial planning & APY tracking — 60 min",
      "Creative brainstorming / sketching — 60–120 min",
      "Hygiene — night"
    ]
  }
};

function load(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch(e){ return fallback; }
}
function save(key, obj) { localStorage.setItem(key, JSON.stringify(obj)); showSaved(); }
function showSaved() {
  const el = document.getElementById('saveState');
  el.textContent = "All changes saved ✔";
  el.style.opacity = 1;
  setTimeout(()=>{ el.style.opacity = 0.7; }, 800);
}

let cfg = load(KEY_CFG, defaultCfg);
let state = load(KEY_STATE, {});
let pref = load(KEY_PREF, { manualDay: "auto" });

// Helpers
function parseRolloverHour() {
  return Number(cfg.rolloverHour) || 15;
}
function getNowAdjusted() {
  const now = new Date();
  const hour = parseRolloverHour();
  const adj = new Date(now);
  if (now.getHours() < hour || (now.getHours() === hour && now.getMinutes() < 0)) {
    adj.setDate(now.getDate() - 1);
  }
  adj.setHours(0,0,0,0);
  return { now, adj, hour };
}
function dayIndexSinceStart() {
  const { adj } = getNowAdjusted();
  const start = new Date(cfg.startDateISO + "T00:00:00");
  const diffDays = Math.floor((adj - start) / (1000*60*60*24));
  return (diffDays % 3 + 3) % 3; // 0..2
}
function dayLabelFromIndex(i) { return ["A","B","C"][i]; }
function nextLabel(i) { return ["B","C","A"][i]; }
function currentDay() {
  if (pref.manualDay !== "auto") return pref.manualDay;
  return dayLabelFromIndex(dayIndexSinceStart());
}
function dateKey() {
  const { adj } = getNowAdjusted();
  return adj.toISOString().slice(0,10);
}
function fmtHour(h) {
  const mm = "00";
  let period = "AM";
  let hh = h;
  if (h === 0) hh = 12;
  else if (h === 12) period = "PM";
  else if (h > 12) { hh = h - 12; period = "PM"; }
  return `${hh}:00 ${period}`;
}

function render() {
  const cur = currentDay();
  document.getElementById('dayLabel').textContent = "Day " + cur;
  const idx = ["A","B","C"].indexOf(cur);
  document.getElementById('nextLabel').textContent = "Day " + nextLabel(idx);

  // countdown
  const { now, hour } = getNowAdjusted();
  const nextRollover = new Date(now);
  if (now.getHours() >= hour) nextRollover.setDate(now.getDate() + 1);
  nextRollover.setHours(hour, 0, 0, 0);
  const mins = Math.max(0, Math.round((nextRollover - now)/60000));
  const h = Math.floor(mins/60), m = mins % 60;
  document.getElementById('since').textContent = `${h}h ${m}m`;
  document.getElementById('rolloverLabel').textContent = fmtHour(hour);

  // list
  const list = document.getElementById('list');
  list.innerHTML = "";
  const tasks = cfg.tasks[cur] ?? [];
  tasks.forEach((t, i) => {
    const row = document.createElement('div');
    row.className = "item";
    const cb = document.createElement('input');
    cb.type = "checkbox";
    const key = dateKey() + "_" + cur + "_" + i;
    cb.checked = !!state[key];
    cb.addEventListener('change', () => {
      state[key] = cb.checked;
      save(KEY_STATE, state);
    });
    const label = document.createElement('label');
    label.textContent = t;
    row.appendChild(cb);
    row.appendChild(label);
    list.appendChild(row);
  });

  // editor fields
  document.getElementById("taA").value = (cfg.tasks.A || []).join("\n");
  document.getElementById("taB").value = (cfg.tasks.B || []).join("\n");
  document.getElementById("taC").value = (cfg.tasks.C || []).join("\n");
  document.getElementById("startDate").value = cfg.startDateISO;
  const hh = String(parseRolloverHour()).padStart(2,"0") + ":00";
  document.getElementById("rolloverHour").value = hh;

  // manual day
  document.getElementById("manualDay").value = pref.manualDay;
}

// Event wiring
document.getElementById('manualDay').addEventListener('change', (e)=>{
  pref.manualDay = e.target.value;
  save(KEY_PREF, pref);
  render();
});

document.getElementById('forceNext').addEventListener('click', ()=>{
  if (confirm("Advance to the next day now? (This will clear today's checks.)")) {
    // move the startDateISO back by 1 day so modulo bumps forward
    const start = new Date(cfg.startDateISO + "T00:00:00");
    start.setDate(start.getDate() - 1);
    cfg.startDateISO = start.toISOString().slice(0,10);
    // clear checks for new "day"
    state = { __key: dateKey() };
    save(KEY_CFG, cfg);
    save(KEY_STATE, state);
    render();
  }
});

document.getElementById('saveRollover').addEventListener('click', ()=>{
  const val = document.getElementById('rolloverHour').value; // "HH:MM"
  const hour = Number(val.split(":")[0] || "15");
  cfg.rolloverHour = hour;
  save(KEY_CFG, cfg);
  render();
});

document.getElementById('resetChecks').addEventListener('click', ()=>{
  if (confirm("Reset all checkboxes for the current day?")) {
    const cur = currentDay();
    const tasks = cfg.tasks[cur] ?? [];
    const keyPrefix = dateKey() + "_" + cur + "_";
    Object.keys(state).forEach(k=>{
      if (k.startsWith(keyPrefix)) delete state[k];
    });
    save(KEY_STATE, state);
    render();
  }
});

["taA","taB","taC"].forEach(id=>{
  document.getElementById(id).addEventListener('input', (e)=>{
    const v = e.target.value.split("\n").map(s=>s.trim()).filter(Boolean);
    const key = id.slice(-1); // A/B/C
    cfg.tasks[key] = v;
    save(KEY_CFG, cfg);
    render();
  });
});

document.getElementById('startDate').addEventListener('change', (e)=>{
  cfg.startDateISO = e.target.value || new Date().toISOString().slice(0,10);
  // new cycle day → clear state
  state = { __key: dateKey() };
  save(KEY_CFG, cfg);
  save(KEY_STATE, state);
  render();
});

// Service worker + install
let deferredPrompt;
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try { await navigator.serviceWorker.register('./sw.js'); } catch(e){}
  });
}
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  btn.style.display = 'inline-block';
  btn.addEventListener('click', async ()=>{
    btn.style.display = 'none';
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
  });
});

// Timer: re-render periodically to update countdown and handle day changes
setInterval(()=>{
  const key = dateKey();
  if (state.__key !== key) {
    state = { __key: key };
    save(KEY_STATE, state);
  }
  render();
}, 60*1000);

// Initial render
render();
</script>
</body>
</html>
